#!/usr/bin/env bash
set -e

# åˆ›å»ºè„šæœ¬ç›®å½•
mkdir -p scripts

# æ£€æŸ¥æ˜¯å¦åœ¨Androidé¡¹ç›®æ ¹ç›®å½•
if [ ! -f "build.gradle" ] && [ ! -f "build.gradle.kts" ]; then
  echo "âš ï¸  å½“å‰ç›®å½•ä¸æ˜¯Androidé¡¹ç›®æ ¹ç›®å½•"
  echo "   è¯·ç¡®ä¿åœ¨åŒ…å« build.gradle æˆ– build.gradle.kts çš„ç›®å½•ä¸‹è¿è¡Œæ­¤è„šæœ¬"
  exit 1
fi

# æ£€æµ‹é¡¹ç›®ç±»å‹
PROJECT_TYPE="unknown"
if [ -f "settings.gradle.kts" ] || [ -f "build.gradle.kts" ]; then
  PROJECT_TYPE="kotlin-dsl"
elif [ -f "settings.gradle" ] || [ -f "build.gradle" ]; then
  PROJECT_TYPE="groovy-dsl"
fi

echo "ğŸ” æ£€æµ‹åˆ°é¡¹ç›®ç±»å‹: $PROJECT_TYPE"

# ç”Ÿæˆ lint.xml é…ç½®æ–‡ä»¶
cat <<EOF > lint.xml
<?xml version="1.0" encoding="UTF-8"?>
<lint>
    <!-- é”™è¯¯çº§åˆ«è§„åˆ™ -->
    <issue id="HardcodedText" severity="error" />
    <issue id="MissingTranslation" severity="error" />
    <issue id="UnusedResources" severity="error" />
    <issue id="IconMissingDensityFolder" severity="error" />
    <issue id="SecurityLogCatch" severity="error" />
    <issue id="LogConditional" severity="error" />
    
    <!-- è­¦å‘Šçº§åˆ«è§„åˆ™ -->
    <issue id="UselessParent" severity="warning" />
    <issue id="InefficientWeight" severity="warning" />
    <issue id="NestedWeights" severity="warning" />
    <issue id="DisableBaselineAlignment" severity="warning" />
    <issue id="ObsoleteLayoutParam" severity="warning" />
    <issue id="Overdraw" severity="warning" />
    
    <!-- æ€§èƒ½ç›¸å…³ -->
    <issue id="DrawAllocation" severity="warning" />
    <issue id="Recycle" severity="error" />
    <issue id="WakelockTimeout" severity="warning" />
    
    <!-- å®‰å…¨ç›¸å…³ -->
    <issue id="AllowBackup" severity="warning" />
    <issue id="ExportedActivity" severity="warning" />
    <issue id="ExportedReceiver" severity="warning" />
    <issue id="ExportedService" severity="warning" />
    
    <!-- å¿½ç•¥çš„è§„åˆ™ -->
    <issue id="GoogleAppIndexingWarning" severity="ignore" />
    <issue id="LintBaseline" severity="ignore" />
    
    <!-- Kotlin ç›¸å…³ -->
    <issue id="UnsafeCall" severity="error" />
    <issue id="NullSafeMutableLiveData" severity="warning" />
</lint>
EOF

# ç”Ÿæˆ ktlint é…ç½®æ–‡ä»¶ (.editorconfig)
cat <<EOF > .editorconfig
root = true

[*]
charset = utf-8
end_of_line = lf
indent_style = space
indent_size = 4
insert_final_newline = true
max_line_length = 120
trim_trailing_whitespace = true

[*.{kt,kts}]
indent_size = 4
continuation_indent_size = 4

[*.{xml,html}]
indent_size = 4

[*.{json,yml,yaml}]
indent_size = 2

[*.md]
trim_trailing_whitespace = false
EOF

# ç”Ÿæˆ .gitignoreï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
if [ ! -f ".gitignore" ]; then
cat <<EOF > .gitignore
# Built application files
*.apk
*.aab

# Files for the ART/Dalvik VM
*.dex

# Java class files
*.class

# Generated files
bin/
gen/
out/
release/

# Gradle files
.gradle/
build/

# Local configuration file (sdk path, etc)
local.properties

# Proguard folder generated by Eclipse
proguard/

# Log Files
*.log

# Android Studio Navigation editor temp files
.navigation/

# Android Studio captures folder
captures/

# IntelliJ
*.iml
.idea/workspace.xml
.idea/tasks.xml
.idea/gradle.xml
.idea/assetWizardSettings.xml
.idea/dictionaries
.idea/libraries
.idea/jarRepositories.xml
.idea/caches
.idea/modules.xml
.idea/.name
.idea/compiler.xml
.idea/copyright/profiles_settings.xml
.idea/encodings.xml
.idea/scopes/scope_settings.xml
.idea/vcs.xml
.idea/jsLibraryMappings.xml
.idea/datasources.xml
.idea/dataSources.ids
.idea/sqlDataSources.xml
.idea/dynamic.xml
.idea/uiDesigner.xml

# OS-specific files
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# Android Lint
lint-results.html
lint-results_files/
lint-report.txt

# Ktlint
.ktlint

# Backup files
*.bak
EOF
fi

# æ ¹æ®é¡¹ç›®ç±»å‹ç”Ÿæˆ Gradle é…ç½®
if [ "$PROJECT_TYPE" = "kotlin-dsl" ]; then
  # Kotlin DSL é¡¹ç›®é…ç½®
  cat <<'EOF' > gradle-config.kts
// å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°ä½ çš„ app/build.gradle.kts æ–‡ä»¶ä¸­

android {
    lint {
        // å¯ç”¨ lint æ£€æŸ¥
        abortOnError = true
        warningsAsErrors = false
        checkDependencies = true
        checkGeneratedSources = false
        explainIssues = true
        
        // å¿½ç•¥çš„æ–‡ä»¶å’Œç›®å½•
        ignoreTestSources = true
        ignoreTestFixturesSources = true
        
        // è¾“å‡ºæ ¼å¼
        htmlReport = true
        htmlOutput = file("$buildDir/reports/lint/lint-results.html")
        xmlReport = true
        xmlOutput = file("$buildDir/reports/lint/lint-results.xml")
        
        // ä½¿ç”¨é…ç½®æ–‡ä»¶
        lintConfig = file("../lint.xml")
        
        // åŸºçº¿æ–‡ä»¶
        baseline = file("lint-baseline.xml")
    }
    
    // Ktlint é…ç½®
    // åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ build.gradle.kts æ·»åŠ ï¼š
    /*
    plugins {
        id("org.jlleitschuh.gradle.ktlint") version "11.6.1" apply false
    }
    */
    
    // åœ¨ app/build.gradle.kts æ·»åŠ ï¼š
    /*
    plugins {
        id("org.jlleitschuh.gradle.ktlint")
    }
    
    ktlint {
        version.set("0.50.0")
        debug.set(false)
        verbose.set(true)
        android.set(true)
        outputToConsole.set(true)
        outputColorName.set("RED")
        ignoreFailures.set(false)
        enableExperimentalRules.set(false)
        
        filter {
            exclude("**/generated/**")
            include("**/kotlin/**")
        }
    }
    */
}
EOF
else
  # Groovy DSL é¡¹ç›®é…ç½®
  cat <<'EOF' > gradle-config.gradle
// å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°ä½ çš„ app/build.gradle æ–‡ä»¶ä¸­

android {
    lint {
        // å¯ç”¨ lint æ£€æŸ¥
        abortOnError true
        warningsAsErrors false
        checkDependencies true
        checkGeneratedSources false
        explainIssues true
        
        // å¿½ç•¥çš„æ–‡ä»¶å’Œç›®å½•
        ignoreTestSources true
        ignoreTestFixturesSources true
        
        // è¾“å‡ºæ ¼å¼
        htmlReport true
        htmlOutput file("$buildDir/reports/lint/lint-results.html")
        xmlReport true
        xmlOutput file("$buildDir/reports/lint/lint-results.xml")
        
        // ä½¿ç”¨é…ç½®æ–‡ä»¶
        lintConfig file("../lint.xml")
        
        // åŸºçº¿æ–‡ä»¶
        baseline file("lint-baseline.xml")
    }
}

// Ktlint é…ç½®
// åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ build.gradle æ·»åŠ ï¼š
/*
plugins {
    id "org.jlleitschuh.gradle.ktlint" version "11.6.1" apply false
}
*/

// åœ¨ app/build.gradle æ·»åŠ ï¼š
/*
apply plugin: "org.jlleitschuh.gradle.ktlint"

ktlint {
    version = "0.50.0"
    debug = false
    verbose = true
    android = true
    outputToConsole = true
    outputColorName = "RED"
    ignoreFailures = false
    enableExperimentalRules = false
    
    filter {
        exclude("**/generated/**")
        include("**/kotlin/**")
    }
}
*/
EOF
fi

# ç”Ÿæˆ Makefile
cat <<EOF > Makefile
.PHONY: lint ktlint format commit commit-force
lint:
	./gradlew lint

ktlint:
	./gradlew ktlintCheck

format:
	./gradlew ktlintFormat

commit:
	bash scripts/android-smart-commit.sh

commit-force:
	bash scripts/android-smart-commit.sh --force

setup:
	@echo "ğŸ“‹ è¯·æ‰‹åŠ¨å®Œæˆä»¥ä¸‹é…ç½®ï¼š"
	@echo "1. å°† gradle-config.${PROJECT_TYPE} ä¸­çš„å†…å®¹æ·»åŠ åˆ°å¯¹åº”çš„ Gradle æ–‡ä»¶"
	@echo "2. è¿è¡Œ ./gradlew ktlintApplyToIdea æ¥é…ç½® Android Studio"
	@echo "3. ä½¿ç”¨ 'make lint' è¿è¡Œ Android Lint æ£€æŸ¥"
	@echo "4. ä½¿ç”¨ 'make ktlint' è¿è¡Œ Ktlint æ£€æŸ¥"
	@echo "5. ä½¿ç”¨ 'make format' è‡ªåŠ¨æ ¼å¼åŒ– Kotlin ä»£ç "
EOF

# ç”Ÿæˆ Android æ™ºèƒ½æäº¤è„šæœ¬
cat <<'EOF' > scripts/android-smart-commit.sh
#!/usr/bin/env bash
set -e

# æ£€æŸ¥å¼ºåˆ¶æ¨¡å¼
FORCE_MODE=false
if [[ "$1" == "--force" ]]; then
  FORCE_MODE=true
fi

# æ£€æŸ¥æ˜¯å¦åœ¨Androidé¡¹ç›®æ ¹ç›®å½•
if [ ! -f "build.gradle" ] && [ ! -f "build.gradle.kts" ]; then
  echo "âŒ é”™è¯¯ï¼šè¯·åœ¨Androidé¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œæ­¤è„šæœ¬"
  exit 1
fi

# è‡ªåŠ¨æ·»åŠ æ–‡ä»¶å˜æ›´
if [ -n "$(git diff --name-only)" ] || [ -n "$(git diff --cached --name-only)" ]; then
  echo "ğŸ“¦ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè‡ªåŠ¨æ‰§è¡Œ git add ."
  git add .
fi

echo ""
echo "âœ¨ Step 1: Ktlint æ ¼å¼åŒ–"
if [ -f "gradlew" ]; then
  # è¯¢é—®æ˜¯å¦éœ€è¦æ ¼å¼åŒ–
  read -p "ğŸ¤” æ˜¯å¦è¿è¡Œ Ktlint è‡ªåŠ¨æ ¼å¼åŒ–ï¼Ÿ(Y/n): " FORMAT_CONFIRM
  FORMAT_CONFIRM=${FORMAT_CONFIRM:-y}
  
  if [[ "$FORMAT_CONFIRM" =~ ^[Yy]$ ]]; then
    echo "ğŸ”§ æ­£åœ¨è¿è¡Œ Ktlint æ ¼å¼åŒ–..."
    if ./gradlew ktlintFormat > /dev/null 2>&1; then
      echo "âœ… Ktlint æ ¼å¼åŒ–å®Œæˆ"
      if [ -n "$(git diff --name-only)" ]; then
        echo "ğŸ“¦ æ ¼å¼åŒ–åæ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè‡ªåŠ¨æš‚å­˜"
        git add .
      fi
    else
      echo "âš ï¸ Ktlint æ ¼å¼åŒ–å¤±è´¥ï¼Œå¯èƒ½é¡¹ç›®æœªé…ç½® Ktlint"
    fi
  else
    echo "â© è·³è¿‡ Ktlint æ ¼å¼åŒ–"
  fi
else
  echo "âš ï¸ æœªæ‰¾åˆ° gradlewï¼Œè·³è¿‡ Ktlint æ ¼å¼åŒ–"
fi

echo ""
echo "ğŸ” Step 2: è¿è¡Œ Ktlint æ£€æŸ¥..."
if [ -f "gradlew" ]; then
  if ./gradlew ktlintCheck; then
    echo "âœ… Ktlint æ£€æŸ¥é€šè¿‡"
  else
    echo "â›” Ktlint æ£€æŸ¥å¤±è´¥"
    if [ "$FORCE_MODE" = false ]; then
      read -p "ğŸ¤” æ˜¯å¦ç»§ç»­æäº¤ï¼Ÿ(y/N): " CONTINUE_CONFIRM
      CONTINUE_CONFIRM=${CONTINUE_CONFIRM:-n}
      if [[ ! "$CONTINUE_CONFIRM" =~ ^[Yy]$ ]]; then
        echo "âŒ å·²å–æ¶ˆæäº¤"
        exit 1
      fi
    else
      echo "âš ï¸ å¼ºåˆ¶æ¨¡å¼ï¼šå¿½ç•¥ Ktlint é”™è¯¯ç»§ç»­æäº¤"
    fi
  fi
else
  echo "âš ï¸ æœªæ‰¾åˆ° gradlewï¼Œè·³è¿‡ Ktlint æ£€æŸ¥"
fi

echo ""
echo "ğŸ” Step 3: è¿è¡Œ Android Lint æ£€æŸ¥..."
if [ -f "gradlew" ]; then
  if ./gradlew lint; then
    echo "âœ… Android Lint æ£€æŸ¥é€šè¿‡"
  else
    echo "â›” Android Lint æ£€æŸ¥å¤±è´¥"
    echo "ğŸ“‹ æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š: build/reports/lint/lint-results.html"
    if [ "$FORCE_MODE" = false ]; then
      read -p "ğŸ¤” æ˜¯å¦ç»§ç»­æäº¤ï¼Ÿ(y/N): " CONTINUE_CONFIRM
      CONTINUE_CONFIRM=${CONTINUE_CONFIRM:-n}
      if [[ ! "$CONTINUE_CONFIRM" =~ ^[Yy]$ ]]; then
        echo "âŒ å·²å–æ¶ˆæäº¤"
        exit 1
      fi
    else
      echo "âš ï¸ å¼ºåˆ¶æ¨¡å¼ï¼šå¿½ç•¥ Android Lint é”™è¯¯ç»§ç»­æäº¤"
    fi
  fi
else
  echo "âš ï¸ æœªæ‰¾åˆ° gradlewï¼Œè·³è¿‡ Android Lint æ£€æŸ¥"
fi

echo ""
echo "ğŸ¤– Step 4: ç”Ÿæˆæäº¤ä¿¡æ¯å¹¶æäº¤..."
echo "ğŸ“ æ­£åœ¨è°ƒç”¨ GPTCommit ç”Ÿæˆæäº¤ä¿¡æ¯..."
git commit --quiet --no-edit
echo ""
echo "ğŸ‰ æäº¤å®Œæˆï¼"
EOF

chmod +x scripts/android-smart-commit.sh

# åˆ›å»ºç¤ºä¾‹ Kotlin Activityï¼ˆå¦‚æœ app/src/main/java ç›®å½•å­˜åœ¨ï¼‰
if [ -d "app/src/main/java" ]; then
  # æŸ¥æ‰¾åŒ…å
  PACKAGE_DIR=$(find app/src/main/java -type d -mindepth 1 | head -1)
  if [ -n "$PACKAGE_DIR" ]; then
    PACKAGE_NAME=$(echo "$PACKAGE_DIR" | sed 's|app/src/main/java/||' | tr '/' '.')
    
    cat <<EOF > "${PACKAGE_DIR}/ExampleActivity.kt"
package ${PACKAGE_NAME}

import android.os.Bundle
import androidx.appcompat.app.AppCompatActivity

/**
 * ç¤ºä¾‹ Activity - å±•ç¤ºä»£ç è§„èŒƒ
 */
class ExampleActivity : AppCompatActivity() {
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        // ç¤ºä¾‹ï¼šç¬¦åˆ Kotlin ä»£ç è§„èŒƒ
        val message = getString(R.string.app_name)
        setupViews(message)
    }
    
    private fun setupViews(title: String) {
        // ä»£ç å®ç°
        supportActionBar?.title = title
    }
    
    companion object {
        private const val TAG = "ExampleActivity"
    }
}
EOF
    echo "ğŸ“ å·²åˆ›å»ºç¤ºä¾‹æ–‡ä»¶: ${PACKAGE_DIR}/ExampleActivity.kt"
  fi
fi

echo ""
echo "âœ… Android Lint/Ktlint è„šæœ¬ä¸é…ç½®åˆå§‹åŒ–å®Œæˆï¼"
echo "   - lint.xml (Android Lint è§„åˆ™é…ç½®)"
echo "   - .editorconfig (Ktlint ä»£ç é£æ ¼é…ç½®)"
echo "   - .gitignore (å¦‚æœä¸å­˜åœ¨)"
echo "   - gradle-config.${PROJECT_TYPE} (Gradle é…ç½®ç¤ºä¾‹)"
echo "   - scripts/android-smart-commit.sh (æ™ºèƒ½æäº¤è„šæœ¬)"
echo "   - Makefile (å¿«æ·å‘½ä»¤)"
if [ -d "app/src/main/java" ]; then
echo "   - ExampleActivity.kt (ç¤ºä¾‹ä»£ç æ–‡ä»¶)"
fi
echo ""
echo "ğŸ¯ ä¸‹ä¸€æ­¥é…ç½®ï¼š"
echo "   1. è¿è¡Œ 'make setup' æŸ¥çœ‹é…ç½®è¯´æ˜"
echo "   2. å°† gradle-config ä¸­çš„å†…å®¹æ·»åŠ åˆ°å¯¹åº”çš„ Gradle æ–‡ä»¶"
echo "   3. è¿è¡Œ 'make lint' æ£€æŸ¥ Android Lint"
echo "   4. è¿è¡Œ 'make ktlint' æ£€æŸ¥ Kotlin ä»£ç é£æ ¼"
echo "   5. ä½¿ç”¨ 'make commit' è¿›è¡Œæ™ºèƒ½æäº¤"
echo ""
echo "ğŸ“– å¸¸ç”¨å‘½ä»¤ï¼š"
echo "   â€¢ make lint         - è¿è¡Œ Android Lint æ£€æŸ¥"
echo "   â€¢ make ktlint       - è¿è¡Œ Ktlint æ£€æŸ¥"
echo "   â€¢ make format       - è‡ªåŠ¨æ ¼å¼åŒ– Kotlin ä»£ç "
echo "   â€¢ make commit       - æ™ºèƒ½æäº¤ï¼ˆæ ¼å¼åŒ–éœ€è¯¢é—®ï¼Œæ£€æŸ¥é”™è¯¯æ—¶ä¼šè¯¢é—®ï¼‰"
echo "   â€¢ make commit-force - å¼ºåˆ¶æäº¤ï¼ˆå¿½ç•¥ lint é”™è¯¯ï¼‰"
echo "" 